<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- ç»ˆæä¿é™©ï¼šå°†ç¬¬ä¸€ä¸ªå­—æ”¹ä¸º Rï¼Œå³ä½¿å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè‹¹æœä¹Ÿä¼šç”¨ R ä½œä¸ºå…œåº•å›¾æ ‡ -->
    <title>Reshape</title>
    
    <!-- PWA æ ¸å¿ƒé…ç½® -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://ui-avatars.com/api/?name=R&background=0F172A&color=FACC15&size=180&font-size=0.65&bold=true&v=v6_cloud">
    <link rel="icon" type="image/png" href="https://ui-avatars.com/api/?name=R&background=0F172A&color=FACC15&size=180&font-size=0.65&bold=true&v=v6_cloud">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Reshape">
    <meta name="theme-color" content="#0F172A">

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,900;1,900&display=swap" rel="stylesheet">
    
    <!-- React & Recharts -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <!-- âš ï¸ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ Firebase Compat SDK ç›´æ¥å…¨å±€å¼•å…¥ï¼Œå½»åº•è§£å†³ require æŠ¥é”™ âš ï¸ -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #0F172A; color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .material-icons-round { vertical-align: middle; font-size: inherit; }
        input[type="date"] { color-scheme: dark; }
        input { -webkit-appearance: none; border-radius: 0; outline: none; background: transparent; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .font-brand { font-family: 'Montserrat', sans-serif; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #facc15; margin-top: -8px; box-shadow: 0 0 10px rgba(250,204,21, 0.5); cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const Icon = ({ name, className, size = 24 }) => <span className={`material-icons-round ${className}`} style={{fontSize: size+'px'}}>{name}</span>;
        const SpikeLogo = ({ className, size = 48 }) => (
            <div className={`relative flex items-center justify-center ${className}`} style={{ width: size, height: size }}>
                <div className="relative w-full h-full">
                    <span className="font-brand font-black text-white absolute inset-0 flex items-center justify-center transform scale-y-110 italic" style={{ fontSize: size * 0.85 + 'px' }}>R</span>
                    <svg className="absolute inset-0 w-full h-full drop-shadow-[0_0_8px_rgba(250,204,21,0.8)]" viewBox="0 0 100 100">
                        <path d="M70 0 L40 50 H55 L25 100 L60 50 H50 L70 0Z" fill="#facc15" />
                    </svg>
                </div>
            </div>
        );

        // ==========================================
        // ğŸ”‘ æ‚¨ä¸“å±çš„ Firebase å¯†é’¥å·²æ¤å…¥
        // ==========================================
        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAupq_P2R0Mt2LBFiwdSn9P9XLl36k0-rk",
            authDomain: "reshape-app-79f2f.firebaseapp.com",
            projectId: "reshape-app-79f2f",
            storageBucket: "reshape-app-79f2f.firebasestorage.app",
            messagingSenderId: "252096614907",
            appId: "1:252096614907:web:50556334770159130efb5e",
            measurementId: "G-Q8QH2VQ45L"
        };

        const { useState, useEffect, useMemo } = React;
        const RechartsObj = window.Recharts || null;

        // --- Charts ---
        const MiniChart = ({ data }) => {
            if (!RechartsObj || data.length === 0) return null;
            const { AreaChart, Area, ResponsiveContainer } = RechartsObj;
            return (
                <div className="h-16 w-full opacity-50 mt-2">
                    <ResponsiveContainer width="100%" height="100%">
                        <AreaChart data={[...data].reverse().slice(-7)}>
                            <defs><linearGradient id="miniGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#facc15" stopOpacity={0.4}/><stop offset="95%" stopColor="#facc15" stopOpacity={0}/></linearGradient></defs>
                            <Area type="monotone" dataKey="weight" stroke="#facc15" strokeWidth={2} fill="url(#miniGradient)" />
                        </AreaChart>
                    </ResponsiveContainer>
                </div>
            );
        };

        // --- ä¸»ç¨‹åº ---
        const App = () => {
            // äº‘ç«¯çŠ¶æ€
            const [authState, setAuthState] = useState('CHECKING'); // CHECKING, NO_CONFIG, LOGIN, LOGGED_IN
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [appId, setAppId] = useState('reshape-cloud-v1');
            
            // ç™»å½•è¡¨å•
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState('');
            const [isAuthLoading, setIsAuthLoading] = useState(false);

            // åº”ç”¨æ•°æ®
            const [profile, setProfile] = useState({ initialized: false });
            const [logs, setLogs] = useState([]);
            const [weeklyRate, setWeeklyRate] = useState(0.5);

            // UI çŠ¶æ€
            const [onboardingStep, setOnboardingStep] = useState(0); 
            const [activeTab, setActiveTab] = useState('home');
            const [isEntryOpen, setIsEntryOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [editingLogId, setEditingLogId] = useState(null);
            const [deleteId, setDeleteId] = useState(null);
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], weight: '', muscle: '', fat: '' });
            const [tempProfile, setTempProfile] = useState({});

            // 1. åˆå§‹åŒ– Firebase äº‘æœåŠ¡å™¨ (Compat API)
            useEffect(() => {
                let unsubAuth = () => {};
                try {
                    // åˆå§‹åŒ– Firebase (é˜²æ­¢é‡å¤åˆå§‹åŒ–)
                    if (!firebase.apps.length) {
                        firebase.initializeApp(MY_FIREBASE_CONFIG);
                    }
                    
                    const auth = firebase.auth();
                    const firestore = firebase.firestore();
                    setDb(firestore);

                    // ç›‘å¬ç™»å½•çŠ¶æ€
                    unsubAuth = auth.onAuthStateChanged((u) => {
                        if (u) {
                            setUser(u);
                            setAuthState('LOGGED_IN');
                        } else {
                            setUser(null);
                            setAuthState('LOGIN');
                        }
                    });
                } catch (err) {
                    console.error("Cloud init failed", err);
                    setAuthError("æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚");
                    setAuthState('LOGIN');
                }
                
                return () => unsubAuth();
            }, []);

            // 2. ç™»å½•/æ³¨å†Œé€»è¾‘
            const handleLoginSubmit = async (e) => {
                e.preventDefault();
                setIsAuthLoading(true);
                setAuthError('');
                try {
                    const auth = firebase.auth();
                    try {
                        // å°è¯•ç™»å½•
                        await auth.signInWithEmailAndPassword(email, password);
                    } catch (err) {
                        // å¦‚æœè´¦å·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨æ³¨å†Œ
                        if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                            try {
                                await auth.createUserWithEmailAndPassword(email, password);
                            } catch (regErr) {
                                setAuthError(regErr.message);
                            }
                        } else {
                            setAuthError(err.message);
                        }
                    }
                } catch (err) {
                    setAuthError("æ“ä½œå¤±è´¥ï¼š" + err.message);
                } finally {
                    setIsAuthLoading(false);
                }
            };

            const handleLogout = async () => {
                if(window.confirm("ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ")) {
                    await firebase.auth().signOut();
                    setIsSettingsOpen(false);
                }
            };

            // 3. æ•°æ®åŒæ­¥ä¸è¿ç§» (äº‘ç«¯ <-> æœ¬åœ°)
            useEffect(() => {
                if (authState !== 'LOGGED_IN' || !user || !db) return;

                const profileRef = db.doc(`artifacts/${appId}/users/${user.uid}/config/profile`);
                const logsRef = db.collection(`artifacts/${appId}/users/${user.uid}/logs`);

                // ç›‘å¬æ¡£æ¡ˆ
                const unsubProfile = profileRef.onSnapshot(async (snap) => {
                    if (snap.exists) {
                        const data = snap.data();
                        setProfile(data.profileData || { initialized: false });
                        setWeeklyRate(data.weeklyRate || 0.5);
                    } else {
                        // äº‘ç«¯æ²¡æ•°æ®ï¼Ÿä»æ—§ç‰ˆ LocalStorage å·æ•°æ®ä¸Šä¼ ï¼(æ— æ„Ÿè¿ç§»)
                        const localProfile = localStorage.getItem('reshape_global_profile');
                        const localRate = localStorage.getItem('reshape_global_weekly_rate');
                        if (localProfile) {
                            const pData = JSON.parse(localProfile);
                            const pRate = localRate ? parseFloat(localRate) : 0.5;
                            setProfile(pData); setWeeklyRate(pRate);
                            await profileRef.set({ profileData: pData, weeklyRate: pRate });
                        } else {
                            setProfile({ initialized: false }); // éœ€è¦å»ºæ¡£
                        }
                    }
                });

                // ç›‘å¬æ—¥å¿—
                const unsubLogs = logsRef.onSnapshot(async (snap) => {
                    const fetched = [];
                    snap.forEach(d => fetched.push(d.data()));
                    
                    if (fetched.length === 0) {
                        // è¿ç§»æ—§æ‰“å¡è®°å½•
                        const localLogs = localStorage.getItem('reshape_global_logs');
                        if (localLogs) {
                            const pLogs = JSON.parse(localLogs);
                            setLogs(pLogs);
                            for (const l of pLogs) {
                                await db.doc(`artifacts/${appId}/users/${user.uid}/logs/${l.id}`).set(l);
                            }
                        } else {
                            setLogs([]);
                        }
                    } else {
                        setLogs(fetched.sort((a,b)=>new Date(b.date)-new Date(a.date)));
                    }
                });

                return () => { unsubProfile(); unsubLogs(); };
            }, [authState, user, db, appId]);


            // --- æ•°æ®è®¡ç®—é€»è¾‘ (ä¿ç•™åŸæœ‰ç®—æ³•) ---
            const ACTIVITY_LEVELS = [
                { val: 1.2, label: "ä¹…å", desc: "æå°‘è¿åŠ¨ï¼ŒåŠå…¬å®¤å·¥ä½œ" },
                { val: 1.375, label: "è½»åº¦", desc: "æ¯å‘¨è¿åŠ¨ 1-3 æ¬¡" },
                { val: 1.55, label: "ä¸­åº¦", desc: "æ¯å‘¨è¿åŠ¨ 3-5 æ¬¡" },
                { val: 1.725, label: "é«˜åº¦", desc: "æ¯å‘¨è¿åŠ¨ 6-7 æ¬¡" },
                { val: 1.9, label: "ä¸“ä¸š", desc: "ä½“åŠ›å·¥ä½œæˆ–åŒå€è®­ç»ƒ" }
            ];

            const calculateDateFromRate = (rate, currentW, targetW) => {
                 const start = parseFloat(currentW), target = parseFloat(targetW), r = parseFloat(rate);
                 if (!start || !target || !r || r === 0) return '--';
                 const days = Math.ceil(Math.abs(start - target) / r * 7);
                 const d = new Date(); d.setDate(d.getDate() + days);
                 return d.toISOString().split('T')[0];
            };
            const handleOnboardingGoalChange = (newRate, newTargetWeight) => {
                setWeeklyRate(parseFloat(newRate));
                const newDate = calculateDateFromRate(newRate, profile.startWeight, newTargetWeight);
                setProfile(prev => ({ ...prev, targetWeight: newTargetWeight, targetDate: newDate }));
            };
            const handleSettingsGoalChange = (rate, w) => {
                setWeeklyRate(parseFloat(rate));
                const newDate = calculateDateFromRate(rate, profile.startWeight, w);
                setTempProfile(prev => ({ ...prev, targetWeight: w, targetDate: newDate }));
            };
            const calculateMetrics = (weight, fatMass, muscleMass, prof) => {
                if (!weight || !prof.height || !prof.age) return null;
                const hM = prof.height / 100;
                let bmr = (10 * weight) + (6.25 * prof.height) - (5 * prof.age);
                bmr = prof.gender === 'male' ? bmr + 5 : bmr - 161;
                const tdee = Math.round(bmr * (prof.activityLevel || 1.2));
                const fatRate = (fatMass && weight) ? ((fatMass / weight) * 100) : 0;
                const ffmi = ((weight - (fatMass || 0)) / (hM * hM) + 6.1 * (1.8 - hM)).toFixed(1);
                return { bmi: (weight / (hM * hM)).toFixed(1), bmr: Math.round(bmr), tdee, fatRate: parseFloat(fatRate.toFixed(1)), ffmi: parseFloat(ffmi) };
            };
            const currentStats = useMemo(() => {
                if (logs.length === 0) return null;
                const latest = logs[0];
                const lastFat = logs.find(l => l.fat > 0);
                const displayFat = latest.fat || (lastFat ? lastFat.fat : 0);
                const displayMus = latest.muscle || (lastFat ? lastFat.muscle : 0);
                const m = calculateMetrics(latest.weight, displayFat, displayMus, profile);
                if (!m) return { weight: latest.weight, fatRate: 0, ffmi: 0, bmr: 0, tdee: 0 };
                return { weight: latest.weight, fatRate: m.fatRate, ffmi: m.ffmi, bmr: m.bmr, tdee: m.tdee };
            }, [logs, profile]);

            const dailyTarget = useMemo(() => {
                if (!currentStats || !currentStats.tdee) return 0;
                return Math.round(currentStats.tdee - ((weeklyRate * 7700) / 7));
            }, [currentStats, weeklyRate]);
            
            const progress = useMemo(() => {
                const s = parseFloat(profile.startWeight), t = parseFloat(profile.targetWeight), c = parseFloat(currentStats?.weight || s);
                if (!s || !t) return 0;
                return Math.min(Math.max(((s - c) / (s - t)) * 100, 0), 100).toFixed(0);
            }, [profile, currentStats]);

            const macros = useMemo(() => {
                if (!dailyTarget) return null;
                return {
                    carbs: Math.round(dailyTarget * 0.5 / 4),
                    protein: Math.round(dailyTarget * 0.3 / 4),
                    fat: Math.round(dailyTarget * 0.2 / 9)
                };
            }, [dailyTarget]);

            const calculateWeeklyData = () => {
                if (logs.length === 0) return [];
                const sorted = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
                const groups = {};
                const start = new Date(profile.planStartDate);
                sorted.forEach(log => {
                    const diff = Math.ceil(Math.abs(new Date(log.date) - start) / 86400000);
                    const wIdx = Math.floor(Math.max(0, diff) / 7);
                    if (!groups[wIdx]) groups[wIdx] = { sum: 0, count: 0 };
                    groups[wIdx].sum += log.weight; groups[wIdx].count++;
                });
                return Object.keys(groups).sort((a,b)=>a-b).map(k => ({ week: `W${parseInt(k)+1}`, avgWeight: parseFloat((groups[k].sum/groups[k].count).toFixed(1)) }))
                    .map((w, i, arr) => ({ ...w, change: i === 0 ? 0 : parseFloat((w.avgWeight - arr[i-1].avgWeight).toFixed(1)) }));
            };
            const weeklyData = useMemo(calculateWeeklyData, [logs, profile]);

            // --- äº‘ç«¯æ•°æ®å†™å…¥æ“ä½œ ---
            const saveSettings = async () => {
                setProfile(tempProfile);
                setIsSettingsOpen(false);
                if (db && user) {
                    const profileRef = db.doc(`artifacts/${appId}/users/${user.uid}/config/profile`);
                    await profileRef.set({ profileData: tempProfile, weeklyRate });
                }
            };

            const openAddModal = () => {
                setEditingLogId(null);
                const latestLog = logs[0] || {};
                const latestFatLog = logs.find(l => l.fat > 0) || {};
                const latestMusLog = logs.find(l => l.muscle > 0) || {};
                setFormData({ date: new Date().toISOString().split('T')[0], weight: latestLog.weight || profile.startWeight || '', fat: latestFatLog.fat || '', muscle: latestMusLog.muscle || '' }); 
                setIsEntryOpen(true); 
            };
            const openEditModal = (log) => { setFormData({ date: log.date, weight: log.weight, fat: log.fat || '', muscle: log.muscle || '' }); setEditingLogId(log.id); setIsEntryOpen(true); };
            
            const handleSaveLog = async (e) => { 
                e.preventDefault(); 
                if (!formData.weight || !db || !user) return; 
                const entryId = editingLogId || Date.now(); 
                const entry = { ...formData, id: entryId, weight: parseFloat(formData.weight), fat: parseFloat(formData.fat) || 0, muscle: parseFloat(formData.muscle) || 0 }; 
                
                setIsEntryOpen(false); setEditingLogId(null); 
                await db.doc(`artifacts/${appId}/users/${user.uid}/logs/${entryId}`).set(entry);
            };
            const confirmDelete = async () => { 
                if (deleteId && db && user) { 
                    const idToDelete = deleteId;
                    setDeleteId(null); 
                    await db.doc(`artifacts/${appId}/users/${user.uid}/logs/${idToDelete}`).delete();
                } 
            };
            
            // å»ºæ¡£å®Œæˆä¸Šä¼ äº‘ç«¯
            useEffect(() => { 
                if (onboardingStep === 5) { 
                    setTimeout(async () => { 
                        const initLog = { id: Date.now(), date: new Date().toISOString().split('T')[0], weight: parseFloat(profile.startWeight), fat: parseFloat(profile.startFat)||0, muscle: parseFloat(profile.startMuscle)||0 };
                        const newProfile = {...profile, initialized: true};
                        
                        if (db && user) {
                            const profileRef = db.doc(`artifacts/${appId}/users/${user.uid}/config/profile`);
                            await profileRef.set({ profileData: newProfile, weeklyRate });
                            await db.doc(`artifacts/${appId}/users/${user.uid}/logs/${initLog.id}`).set(initLog);
                        }
                    }, 2000); 
                } 
            }, [onboardingStep]);


            // ================= RENDER =================
            if (authState === 'CHECKING') {
                return <div className="min-h-screen flex items-center justify-center bg-[#0F172A] text-white"><div className="animate-pulse flex flex-col items-center"><SpikeLogo size={64}/><p className="mt-4 text-slate-500 font-bold tracking-widest text-xs">è¿æ¥äº‘ç«¯ç¥ç»...</p></div></div>;
            }

            if (authState === 'NO_CONFIG') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-[#0F172A] text-white p-8">
                        <Icon name="cloud_off" size={64} className="text-rose-500 mb-6 drop-shadow-[0_0_15px_red]" />
                        <h2 className="text-2xl font-black mb-2">é…ç½®é”™è¯¯</h2>
                        <p className="text-center text-slate-400 text-sm leading-relaxed mb-8">æœªæ£€æµ‹åˆ° Firebase å¯†é’¥ï¼Œè¯·æ£€æŸ¥ä»£ç ã€‚</p>
                    </div>
                );
            }

            if (authState === 'LOGIN') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-[#0F172A] text-white p-8 relative overflow-hidden">
                        <div className="absolute top-[-20%] left-[-20%] w-[140%] h-[140%] bg-gradient-to-br from-indigo-600/10 to-purple-600/10 blur-3xl pointer-events-none"></div>
                        <div className="w-full max-w-sm relative z-10 slide-up">
                            <div className="text-center mb-10"><SpikeLogo size={80} className="mx-auto mb-4"/><h1 className="text-3xl font-black tracking-tighter">RESHAPE<span className="text-indigo-500">.ID</span></h1><p className="text-slate-500 text-xs font-bold tracking-widest mt-1 uppercase">äº‘ç«¯æ•°æ®ä¸­æ¢</p></div>
                            <form onSubmit={handleLoginSubmit} className="space-y-4">
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Email</label><input type="email" required className="w-full bg-slate-900/80 border border-slate-800 p-4 rounded-2xl text-white focus:border-indigo-500 transition-colors" value={email} onChange={e=>setEmail(e.target.value)} placeholder="your@email.com"/></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Password</label><input type="password" required className="w-full bg-slate-900/80 border border-slate-800 p-4 rounded-2xl text-white focus:border-indigo-500 transition-colors" value={password} onChange={e=>setPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
                                {authError && <div className="text-rose-500 text-xs font-bold px-2 py-1 bg-rose-500/10 rounded-lg">{authError}</div>}
                                <button type="submit" disabled={isAuthLoading} className="w-full py-4 mt-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-lg shadow-lg shadow-indigo-500/30 transition-all">
                                    {isAuthLoading ? 'éªŒè¯ä¸­...' : 'ç™» å½• / æ³¨ å†Œ'}
                                </button>
                                <p className="text-[10px] text-center text-slate-500 mt-4">é¦–æ¬¡ç™»å½•å°†è‡ªåŠ¨ä¸ºæ‚¨åˆ›å»º Reshape ID</p>
                            </form>
                        </div>
                    </div>
                );
            }

            // --- Logged In App UI ---
            if (!profile.initialized) {
                return (
                    <div className="max-w-md mx-auto min-h-screen bg-[#0F172A] flex flex-col text-white justify-center p-8 overflow-hidden relative">
                        <div className="w-full h-1 bg-slate-800 absolute top-0 left-0"><div className="h-full bg-indigo-500 progress-bar" style={{ width: `${(onboardingStep / 5) * 100}%`, transition: 'width 0.3s ease' }}></div></div>
                        <div className="flex-1 flex flex-col justify-center relative z-10">
                            {onboardingStep === 0 && (
                                <div className="text-center slide-up">
                                    <div className="mb-10"><SpikeLogo size={96} className="mx-auto" /></div>
                                    <h1 className="text-5xl font-black mb-4 tracking-tighter">RESHAPE</h1>
                                    <p className="text-slate-400 text-lg mb-10">æ„å¿—ä¸è‚‰ä½“çš„é‡æ„</p>
                                    <button onClick={() => setOnboardingStep(1)} className="mt-8 w-full py-5 bg-white text-slate-950 font-black rounded-full text-xl shadow-2xl transition-transform active:scale-95">å¼€å§‹é”»é€ </button>
                                </div>
                            )}
                            
                            {onboardingStep === 1 && <div className="w-full slide-up">
                                <h2 className="text-3xl font-black mb-8">åŸºç¡€æ¡£æ¡ˆ</h2>
                                <div className="space-y-8">
                                    <div><label className="text-xs text-indigo-400 font-bold uppercase block mb-2">ä»£å· / æ˜µç§°</label><input autoFocus className="w-full border-b-2 border-slate-700 py-3 text-3xl font-black focus:border-indigo-500 text-white placeholder-slate-700" value={profile.name||''} onChange={e=>setProfile({...profile, name:e.target.value})} placeholder="Name..."/></div>
                                    <div>
                                        <label className="text-xs text-indigo-400 font-bold uppercase block mb-4">ç”Ÿç†æ€§åˆ«</label>
                                        <div className="flex gap-4">
                                            <button onClick={()=>setProfile({...profile, gender:'male'})} className={`flex-1 p-4 rounded-2xl border-2 transition-all flex flex-col items-center gap-2 ${profile.gender==='male'?'border-indigo-500 bg-indigo-500/20 text-white':'border-slate-800 text-slate-500'}`}><Icon name="male" size={32}/><span className="font-bold">ç”·</span></button>
                                            <button onClick={()=>setProfile({...profile, gender:'female'})} className={`flex-1 p-4 rounded-2xl border-2 transition-all flex flex-col items-center gap-2 ${profile.gender==='female'?'border-rose-500 bg-rose-500/20 text-white':'border-slate-800 text-slate-500'}`}><Icon name="female" size={32}/><span className="font-bold">å¥³</span></button>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={()=>setOnboardingStep(2)} disabled={!profile.name || !profile.gender} className="mt-12 w-full py-5 bg-indigo-600 rounded-full font-black text-xl shadow-lg disabled:opacity-50">ä¸‹ä¸€æ­¥</button>
                            </div>}

                            {onboardingStep === 2 && <div className="w-full slide-up">
                                <h2 className="text-3xl font-black mb-8">èº«ä½“å‚æ•°</h2>
                                <div className="space-y-6">
                                    <div className="flex gap-4">
                                        <div className="flex-1"><label className="text-xs text-indigo-400 font-bold uppercase block mb-2">èº«é«˜ (CM)</label><input type="number" className="w-full bg-slate-900 p-5 rounded-2xl text-3xl font-bold" value={profile.height||''} onChange={e=>setProfile({...profile, height:e.target.value})}/></div>
                                        <div className="flex-1"><label className="text-xs text-indigo-400 font-bold uppercase block mb-2">å¹´é¾„</label><input type="number" className="w-full bg-slate-900 p-5 rounded-2xl text-3xl font-bold" value={profile.age||''} onChange={e=>setProfile({...profile, age:e.target.value})}/></div>
                                    </div>
                                    <div>
                                        <label className="text-xs text-indigo-400 font-bold uppercase block mb-3">æ—¥å¸¸æ´»åŠ¨å¼ºåº¦</label>
                                        <div className="grid grid-cols-1 gap-2">
                                            {ACTIVITY_LEVELS.map(level => (
                                                <button key={level.val} onClick={() => setProfile({...profile, activityLevel: level.val})} className={`p-4 rounded-xl text-left border transition-all ${profile.activityLevel === level.val ? 'border-amber-500 bg-amber-500/10' : 'border-slate-800 bg-slate-900'}`}>
                                                    <div className={`text-sm font-bold ${profile.activityLevel === level.val ? 'text-amber-500' : 'text-slate-300'}`}>{level.label}</div>
                                                    <div className="text-xs text-slate-500 mt-0.5">{level.desc}</div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <button onClick={()=>setOnboardingStep(3)} disabled={!profile.height || !profile.age} className="mt-8 w-full py-5 bg-indigo-600 rounded-full font-black text-xl shadow-lg disabled:opacity-50">ä¸‹ä¸€æ­¥</button>
                            </div>}

                            {onboardingStep === 3 && <div className="w-full slide-up">
                                <h2 className="text-3xl font-black mb-8">å½“å‰ç°çŠ¶</h2>
                                <div className="space-y-6"><div><label className="text-xs text-indigo-400 font-bold uppercase block mb-2">å½“å‰ä½“é‡ (KG)</label><input type="number" step="0.1" autoFocus className="w-full bg-slate-900 p-5 rounded-2xl text-5xl font-black" value={profile.startWeight||''} onChange={e=>setProfile({...profile, startWeight:e.target.value})}/></div><div className="grid grid-cols-2 gap-4"><input type="number" step="0.1" className="bg-slate-900 p-4 rounded-xl font-bold text-white placeholder-slate-700" placeholder="ä½“è„‚KG (é€‰å¡«)" value={profile.startFat||''} onChange={e=>setProfile({...profile, startFat:e.target.value})}/><input type="number" step="0.1" className="bg-slate-900 p-4 rounded-xl font-bold text-white placeholder-slate-700" placeholder="è‚Œè‚‰KG (é€‰å¡«)" value={profile.startMuscle||''} onChange={e=>setProfile({...profile, startMuscle:e.target.value})}/></div></div>
                                <button onClick={()=>setOnboardingStep(4)} disabled={!profile.startWeight} className="mt-12 w-full py-5 bg-indigo-600 rounded-full font-black text-xl shadow-lg disabled:opacity-50">ä¸‹ä¸€æ­¥</button>
                            </div>}

                            {onboardingStep === 4 && <div className="w-full slide-up">
                                <h2 className="text-3xl font-black mb-8">å®šä¸‹ç›®æ ‡</h2>
                                <div className="space-y-6">
                                    <div><label className="text-xs text-indigo-400 font-bold uppercase block mb-2">ç›®æ ‡ä½“é‡ (KG)</label><input type="number" step="0.1" className="w-full bg-slate-900 p-5 rounded-2xl text-4xl font-bold" value={profile.targetWeight||''} onChange={e=>handleOnboardingGoalChange(weeklyRate, e.target.value)}/></div>
                                    <div><label className="text-xs text-indigo-400 font-bold uppercase block mb-2">ç›®æ ‡ä½“è„‚ (%)</label><input type="number" step="0.1" className="w-full bg-slate-900 p-5 rounded-2xl text-2xl font-bold" value={profile.targetFatRate||''} onChange={e=>setProfile({...profile, targetFatRate:e.target.value})}/></div>
                                    <div className="bg-slate-800 p-5 rounded-2xl border border-slate-700"><div className="flex justify-between items-center mb-4"><label className="text-xs font-bold text-slate-300 uppercase flex items-center gap-1"><Icon name="speed" size={16} className="text-emerald-400"/> æ¯å‘¨å‡é‡é…é€Ÿ</label><span className="text-emerald-400 font-black text-lg">{weeklyRate} <span className="text-xs text-slate-500 font-bold">KG/å‘¨</span></span></div><input type="range" min="0.1" max="1.5" step="0.1" value={weeklyRate} onChange={e=>handleOnboardingGoalChange(e.target.value, profile.targetWeight)} className="w-full mb-2"/><div className="flex justify-between text-[10px] font-bold text-slate-500 mb-6"><span>æ¸©å’Œ</span><span className={weeklyRate>=0.5&&weeklyRate<=1.0?"text-emerald-400":""}>{weeklyRate>=0.5&&weeklyRate<=1.0?"âœ… é»„é‡‘åŒºé—´":"æ¨è"}</span><span>æé€Ÿ</span></div><div className="flex items-center gap-3 bg-slate-900 p-4 rounded-xl"><div className="p-2 bg-slate-800 rounded-lg text-slate-400"><Icon name="event" size={20}/></div><div><p className="text-[10px] text-slate-500 uppercase font-bold mb-0.5">é¢„è®¡è¾¾æˆæ—¥æœŸ</p><p className="text-white font-bold text-lg">{profile.targetDate||'--'}</p></div></div></div>
                                </div>
                                <button onClick={()=>setOnboardingStep(5)} disabled={!profile.targetWeight || !profile.targetDate} className="mt-8 w-full py-5 bg-indigo-600 rounded-full font-black text-xl shadow-lg disabled:opacity-50">ç”Ÿæˆå¹¶ä¸Šä¼ äº‘ç«¯</button>
                            </div>}

                            {onboardingStep === 5 && <div className="text-center animate-pulse"><SpikeLogo size={80} className="mx-auto mb-8"/><p className="text-xl font-bold tracking-widest uppercase">äº‘ç«¯æ•°æ®åŒæ­¥ä¸­...</p></div>}
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto bg-[#F8FAFC] min-h-screen pb-32 overflow-x-hidden relative text-slate-900">
                    <header className="relative bg-[#0F172A] pb-24 rounded-b-[3.5rem] overflow-hidden shadow-2xl">
                        <div className="absolute top-[-50%] left-[-20%] w-[150%] h-[150%] bg-gradient-to-br from-indigo-900/20 via-slate-900 to-transparent blur-3xl pointer-events-none animate-pulse"></div>
                        <div className="relative z-10 px-8 pt-14 text-white">
                            <div className="flex justify-between items-center mb-8">
                                <div className="flex items-center gap-4">
                                    <SpikeLogo size={48} />
                                    <div>
                                        <div className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-0.5 flex items-center gap-1">
                                            RESHAPE <span className="text-emerald-400 text-[8px] border border-emerald-400/30 px-1 rounded-sm">CLOUD</span>
                                        </div>
                                        <h1 className="text-2xl font-black">{profile.name}</h1>
                                    </div>
                                </div>
                                <button onClick={openSettings} className="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-white/80 hover:bg-white/20 transition-colors"><Icon name="settings" size={20}/></button>
                            </div>
                            <div className="flex justify-between items-end">
                                <div><p className="text-slate-400 text-[10px] font-black uppercase mb-1 tracking-widest">å½“å‰çŠ¶æ€</p><div className="flex items-baseline gap-1.5"><span className="text-7xl font-black tracking-tighter" style={{ textShadow: '0 10px 30px rgba(99, 102, 241, 0.4)' }}>{currentStats?.weight || '--'}</span><span className="text-lg font-bold opacity-40">KG</span></div>{logs.length > 2 && <MiniChart data={logs} />}</div>
                                <div className="text-right mb-2">{streak > 1 && <div className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-yellow-500/20 border border-yellow-500/30 text-yellow-500 text-[10px] font-black mb-3"><Icon name="bolt" size={12}/> {streak} DAY STREAK</div>}<p className="text-slate-400 text-[10px] font-black uppercase mb-1">è·ç¦»ç›®æ ‡</p><p className="text-3xl font-black text-white">{(currentStats?.weight ? currentStats.weight - profile.targetWeight : 0).toFixed(1)}</p></div>
                            </div>
                        </div>
                    </header>

                    <div className="px-6 -mt-16 relative z-20 space-y-5">
                        <div className="bg-white p-6 rounded-[2.5rem] card-shadow border border-white flex gap-4 items-start animate-in fade-in slide-in-from-bottom-6 duration-700">
                            <div className="w-12 h-12 rounded-2xl bg-indigo-50 flex items-center justify-center shrink-0 shadow-inner"><Icon name="auto_awesome" className="text-indigo-500"/></div>
                            <div><h3 className="font-black text-sm mb-1 text-slate-800">äº‘ç«¯å·²åŒæ­¥</h3><p className="text-xs text-slate-500 leading-relaxed font-medium">æ‚¨çš„æ•°æ®å·²å®‰å…¨å­˜å‚¨åœ¨äº‘ç«¯ï¼Œéšæ—¶éšåœ°ä¿æŒåŒæ­¥ã€‚</p></div>
                        </div>

                        {/* Energy Card (With 5:3:2 Macros) */}
                        <div className="bg-amber-50 p-6 rounded-[2.5rem] border border-amber-100 shadow-sm relative overflow-hidden">
                             <div className="absolute -right-6 -top-6 w-24 h-24 bg-amber-500/10 rounded-full blur-xl"></div>
                             <div className="flex justify-between items-start relative z-10">
                                 <div>
                                     <h3 className="text-lg font-black text-amber-900 flex items-center gap-2"><Icon name="local_fire_department" className="text-amber-500" size={20}/> æ¯æ—¥èƒ½é‡è§„åˆ’</h3>
                                     <p className="text-[10px] font-bold text-amber-700/60 mt-1">åŸºäº {weeklyRate}kg/å‘¨ å‡é‡é€Ÿåº¦</p>
                                 </div>
                                 <div className="text-right">
                                     <span className="text-3xl font-black text-amber-600">{dailyTarget}</span>
                                     <div className="text-[10px] font-bold text-amber-500 uppercase">KCAL / Day</div>
                                 </div>
                             </div>
                             {/* 5:3:2 è¥å…»ç´ æ¨è */}
                             {macros && (
                                <div className="mt-4 pt-4 border-t border-amber-200/30">
                                    <div className="flex justify-between items-center mb-2">
                                         <span className="text-[10px] font-bold text-amber-800 uppercase opacity-70">5:3:2 é¥®é£Ÿæ³•æ¨è</span>
                                    </div>
                                    <div className="flex gap-2">
                                        <div className="flex-1 bg-white/60 p-2 rounded-xl text-center"><div className="text-[10px] text-amber-500 font-bold mb-0.5">ç¢³æ°´ (50%)</div><div className="text-base font-black text-amber-900">{macros.carbs}g</div></div>
                                        <div className="flex-1 bg-white/60 p-2 rounded-xl text-center"><div className="text-[10px] text-amber-500 font-bold mb-0.5">è›‹ç™½ (30%)</div><div className="text-base font-black text-amber-900">{macros.protein}g</div></div>
                                         <div className="flex-1 bg-white/60 p-2 rounded-xl text-center"><div className="text-[10px] text-amber-500 font-bold mb-0.5">è„‚è‚ª (20%)</div><div className="text-base font-black text-amber-900">{macros.fat}g</div></div>
                                    </div>
                                </div>
                             )}
                        </div>

                        <div className="bg-[#0F172A] p-7 rounded-[3rem] shadow-xl text-white relative overflow-hidden border border-slate-800">
                             <div className="flex justify-between items-center mb-5"><h3 className="font-black text-base flex items-center gap-2 italic"><Icon name="flag" className="text-indigo-400" size={18}/> ç›®æ ‡ç«é€Ÿ</h3><span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">å‰©ä½™ {raceMetrics.daysLeft} å¤©</span></div>
                             <div className="relative pt-6 pb-2"><div className="h-2.5 bg-slate-800 rounded-full w-full relative overflow-hidden"><div className="absolute top-0 bottom-0 bg-slate-600 transition-all duration-1000" style={{width: `${raceMetrics.timeProgress}%`}}/><div className={`absolute top-0 bottom-0 transition-all duration-1000 z-10 rounded-full ${raceMetrics.status==='AHEAD'?'bg-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.5)]':'bg-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.5)]'}`} style={{width: `${raceMetrics.weightProgress}%`}}/></div><div className="absolute top-0 transition-all duration-1000 z-20" style={{left: `${raceMetrics.weightProgress}%`, transform: 'translateX(-50%)'}}><div className={`px-2 py-0.5 rounded text-[9px] font-black uppercase text-white shadow-lg ${raceMetrics.status==='AHEAD'?'bg-emerald-500':'bg-rose-500'}`}>YOU</div><div className={`w-0.5 h-3 mx-auto ${raceMetrics.status==='AHEAD'?'bg-emerald-500':'bg-rose-500'}`}></div></div><div className="absolute top-3 transition-all duration-1000 opacity-40" style={{left: `${raceMetrics.timeProgress}%`, transform: 'translateX(-50%)'}}><div className="w-0.5 h-5 bg-slate-400 mx-auto border-dashed border-l border-slate-900"></div><div className="text-[9px] text-slate-400 font-bold mt-1 tracking-tighter">TIME</div></div></div>
                        </div>

                        <div className="bg-white p-8 rounded-[3rem] card-shadow border border-slate-100">
                            {activeTab === 'home' && (
                                <div className="space-y-6 fade-in">
                                    <h3 className="text-lg font-black text-slate-800 flex gap-2 items-center mb-8"><Icon name="activity" className="text-indigo-600" size={20}/> æ ¸å¿ƒç›‘æ§</h3>
                                    <Gauge title="ä½“è„‚ç‡ (BF%)" value={currentStats?.fatRate} unit="%" ranges={bfConfig.ranges} minVal={5} maxVal={35} dateLabel={currentStats?.dateLabel}/>
                                    <Gauge title="FFMI è‚Œè‚‰æŒ‡æ•°" value={currentStats?.ffmi} unit="" ranges={ffmiConfig.ranges} minVal={16} maxVal={26} dateLabel={currentStats?.dateLabel}/>
                                </div>
                            )}
                            {activeTab === 'trends' && (
                                <div className="fade-in space-y-6">
                                    <div className="flex justify-between items-center"><h3 className="text-lg font-black text-slate-800">è¶‹åŠ¿åˆ†æ</h3><div className="flex bg-slate-100 rounded-full p-1"><button onClick={()=>setTrendViewMode('daily')} className={`px-4 py-1.5 text-xs font-black rounded-full transition-all ${trendViewMode==='daily'?'bg-white shadow-sm text-indigo-600':'text-slate-400'}`}>æ—¥çº¿</button><button onClick={()=>setTrendViewMode('weekly')} className={`px-4 py-1.5 text-xs font-black rounded-full transition-all ${trendViewMode==='weekly'?'bg-white shadow-sm text-indigo-600':'text-slate-400'}`}>å‘¨æŠ¥</button></div></div>
                                    <div className="h-48">
                                        {logs.length > 1 ? (trendViewMode === 'daily' ? <TrendChartDaily data={trendData}/> : <TrendChartWeekly data={weeklyData}/>) : <div className="h-full flex items-center justify-center text-slate-300 font-bold italic">æ•°æ®è“„èƒ½ä¸­...</div>}
                                    </div>
                                </div>
                            )}
                            {activeTab === 'history' && (
                                <div className="fade-in">
                                    <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-black text-slate-800">æ‰“å¡å†å²</h3><span className="text-[10px] font-black bg-slate-100 text-slate-500 px-2 py-1 rounded uppercase tracking-widest">{logs.length} LOGS</span></div>
                                    <div className="space-y-4 pb-20">
                                        {logs.map(log => (
                                            <div key={log.id} className="flex justify-between items-center p-5 rounded-[2rem] bg-white border border-slate-100 card-shadow">
                                                <div className="flex items-center gap-4"><div className="w-12 h-12 rounded-2xl bg-slate-50 flex flex-col items-center justify-center text-slate-400 font-bold leading-tight"><span className="text-[10px] uppercase">{new Date(log.date).toLocaleString('default',{month:'short'})}</span><span className="text-lg text-slate-800">{new Date(log.date).getDate()}</span></div><div><div className="text-xl font-black text-slate-800">{log.weight}<span className="text-xs ml-1 text-slate-400">KG</span></div><div className="text-[10px] text-slate-400 font-bold mt-0.5 uppercase tracking-tighter">Fat: {log.fat||'-'} / Mus: {log.muscle||'-'}</div></div></div>
                                                <div className="flex gap-2"><button onClick={()=>openEditModal(log)} className="p-3 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all"><Icon name="edit" size={18}/></button><button onClick={()=>requestDelete(log.id)} className="p-3 text-slate-400 hover:text-rose-600 hover:bg-rose-50 rounded-xl transition-all"><Icon name="delete" size={18}/></button></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-sm z-50">
                        <div className="glass-nav rounded-full p-2.5 flex justify-around items-center shadow-2xl nav-shadow border border-white/10">
                            <button onClick={()=>setActiveTab('home')} className={`p-4 rounded-full transition-all duration-300 ${activeTab==='home'?'bg-indigo-600 text-white shadow-lg':'text-slate-400 hover:text-white'}`}><Icon name="dashboard" size={24}/></button>
                            <button onClick={openAddModal} className="w-12 h-12 bg-gradient-to-tr from-indigo-500 to-violet-600 text-white rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/30 active:scale-95 transition-transform"><Icon name="add" size={32}/></button>
                            <button onClick={()=>setActiveTab('trends')} className={`p-4 rounded-full transition-all duration-300 ${activeTab==='trends'?'bg-indigo-600 text-white shadow-lg':'text-slate-400 hover:text-white'}`}><Icon name="show_chart" size={24}/></button>
                            <button onClick={()=>setActiveTab('history')} className={`p-4 rounded-full transition-all duration-300 ${activeTab==='history'?'bg-indigo-600 text-white shadow-lg':'text-slate-400 hover:text-white'}`}><Icon name="history" size={24}/></button>
                        </div>
                    </nav>

                    {/* Modals */}
                    {isEntryOpen && (
                        <div className="fixed inset-0 z-[60] flex items-end">
                            <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onClick={() => setIsEntryOpen(false)}></div>
                            <div className="relative w-full bg-white rounded-t-[3rem] p-8 animate-in slide-in-from-bottom duration-300">
                                <div className="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
                                <h2 className="text-2xl font-black text-slate-800 mb-8 flex items-center gap-2"><Icon name="fitness_center" className="text-indigo-600"/> {editingLogId?'ä¿®æ­£æ•°æ®':'è®°å½•ä»Šæ—¥'}</h2>
                                <form onSubmit={handleSaveLog} className="space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100"><label className="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">æ—¥æœŸ</label><input type="date" className="w-full bg-transparent font-bold text-slate-800" value={formData.date} onChange={e=>setFormData({...formData, date: e.target.value})} /></div>
                                        <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100"><label className="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">ä½“é‡ (KG)</label><input type="number" step="0.1" required autoFocus className="w-full bg-transparent font-black text-2xl text-indigo-600" placeholder="0.0" value={formData.weight} onChange={e=>setFormData({...formData, weight: e.target.value})} /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100"><label className="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">è„‚è‚ªé‡ (KG)</label><input type="number" step="0.1" className="w-full bg-transparent font-bold text-xl text-slate-800" placeholder="--" value={formData.fat} onChange={e=>setFormData({...formData, fat: e.target.value})} /></div>
                                        <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100"><label className="text-[10px] font-black text-slate-400 uppercase mb-2 block tracking-widest">è‚Œè‚‰é‡ (KG)</label><input type="number" step="0.1" className="w-full bg-transparent font-bold text-xl text-slate-800" placeholder="--" value={formData.muscle} onChange={e=>setFormData({...formData, muscle: e.target.value})} /></div>
                                    </div>
                                    <button type="submit" className="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-transform">ç¡®è®¤åŒæ­¥åˆ°äº‘ç«¯</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-[60] flex items-end">
                            <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onClick={() => setIsSettingsOpen(false)}></div>
                            <div className="relative w-full bg-white rounded-t-[3rem] p-8 animate-in slide-in-from-bottom duration-300 max-h-[85vh] overflow-y-auto no-scrollbar">
                                <div className="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
                                <h2 className="text-2xl font-black text-slate-800 mb-8 flex items-center justify-between">
                                    <span className="flex items-center gap-2"><Icon name="tune" className="text-indigo-600"/> è®¡åˆ’è°ƒæ•´</span>
                                    <span className="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-1 rounded font-bold flex items-center gap-1"><Icon name="cloud_done" size={14}/> å·²è¿æ¥äº‘ç«¯</span>
                                </h2>
                                
                                <div className="space-y-6">
                                    <div className="bg-slate-50 p-5 rounded-3xl border border-slate-200">
                                        <h4 className="text-xs text-indigo-400 font-bold uppercase mb-4">ç›®æ ‡è®¾å®š</h4>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase">ç›®æ ‡ä½“é‡</label>
                                                <input type="number" step="0.1" className="w-full bg-white p-3 rounded-xl font-black text-indigo-600 mt-1 shadow-sm" value={tempProfile.targetWeight||''} onChange={e=>handleSettingsGoalChange(weeklyRate, e.target.value)} />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400 uppercase">ç›®æ ‡ä½“è„‚</label>
                                                <input type="number" step="0.1" className="w-full bg-white p-3 rounded-xl font-black text-indigo-600 mt-1 shadow-sm" value={tempProfile.targetFatRate||''} onChange={e=>setTempProfile({...tempProfile, targetFatRate:e.target.value})} />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 p-5 rounded-3xl border border-slate-200">
                                        <h4 className="text-xs text-indigo-400 font-bold uppercase mb-4">æ—¥å¸¸æ´»åŠ¨å¼ºåº¦</h4>
                                        <div className="grid grid-cols-1 gap-2">
                                            {ACTIVITY_LEVELS.map(level => (
                                                <button key={level.val} onClick={() => setTempProfile({...tempProfile, activityLevel: level.val})} className={`p-4 rounded-xl text-left border transition-all flex items-center justify-between ${tempProfile.activityLevel === level.val ? 'border-amber-500 bg-amber-50 shadow-sm' : 'border-slate-200 bg-white'}`}>
                                                    <div>
                                                        <div className={`text-sm font-bold ${tempProfile.activityLevel === level.val ? 'text-amber-600' : 'text-slate-600'}`}>{level.label}</div>
                                                        <div className="text-[10px] text-slate-400 mt-0.5">{level.desc}</div>
                                                    </div>
                                                    {tempProfile.activityLevel === level.val && <Icon name="check_circle" className="text-amber-500" size={20}/>}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="p-5 bg-slate-900 rounded-3xl border border-slate-800 text-white shadow-xl">
                                        <div className="flex justify-between items-center mb-6">
                                            <label className="text-xs font-bold text-slate-400 uppercase flex items-center gap-1">
                                                <Icon name="speed" size={16} className="text-emerald-400"/> å‡é‡é…é€Ÿ
                                            </label>
                                            <span className="text-emerald-400 font-black text-xl">
                                                {weeklyRate} <span className="text-xs text-slate-500 font-bold">KG/å‘¨</span>
                                            </span>
                                        </div>
                                        
                                        <input 
                                            type="range" 
                                            min="0.1" 
                                            max="1.5" 
                                            step="0.1" 
                                            value={weeklyRate} 
                                            onChange={e => handleSettingsGoalChange(e.target.value, tempProfile.targetWeight)} 
                                            className="w-full mb-3"
                                        />
                                        
                                        <div className="flex justify-between text-[10px] font-bold text-slate-500 mb-6 border-b border-slate-800 pb-6">
                                            <span>æ¸©å’Œ</span>
                                            <span className={weeklyRate >= 0.5 && weeklyRate <= 1.0 ? "text-emerald-400" : ""}>
                                                {weeklyRate >= 0.5 && weeklyRate <= 1.0 ? "âœ… é»„é‡‘åŒºé—´" : "æ¨è"}
                                            </span>
                                            <span>æé€Ÿ</span>
                                        </div>

                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <div className="p-2 bg-slate-800 rounded-lg text-slate-400"><Icon name="event" size={20}/></div>
                                                <span className="text-xs text-slate-400 font-bold uppercase">é¢„è®¡è¾¾æˆ</span>
                                            </div>
                                            <p className="text-white font-black text-xl tracking-tight">{tempProfile.targetDate || '--'}</p>
                                        </div>
                                    </div>

                                    <button onClick={saveSettings} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform">
                                        ä¿å­˜å¹¶åŒæ­¥
                                    </button>
                                    
                                    <div className="flex gap-2 mt-4">
                                        <button onClick={handleLogout} className="flex-1 py-4 text-slate-500 bg-slate-100 rounded-2xl font-bold flex items-center justify-center gap-2">
                                            <Icon name="logout" size={18}/> é€€å‡ºè´¦å·
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
